\chapter{Лабораторная работа №4\\Секундомер} 

\par{В прошлых лабораторных работах мы изучили базовые строительные блоки цифровых устройств. Теперь у нас уже достаточно знаний для реализации несложного, но функционально законченного цифрового устройства.}

\par{В данной лабораторной работе мы познакомимся с процессом проектирования полноценного цифрового устройства на примере разработки простого секундомера. Мы подробно, поэтапно, рассмотрим процесс проектирования, проиллюстрировав каждый этап графической схемой.}

\par{Для эффективного проектирования любого цифрового устройства нужно придерживаться некоторой \quotes{канвы} проектирования. Это поможет не запутаться и последовательно разобраться с вопросами, возникающими в ходе проектирования.}

\par{\textbf{Начинать проектирование любого цифрового устройства следует с определения входов и выходов.} Нужно понять какие данные будут входными для проектируемого устройства, и какие данные нам надо выработать и подать на выход.}

\vspace{4mm}
\par{В случае секундомера справедливы такие рассуждения:}
\par{Чтобы управлять работой секундомера нам понадобятся два входа: \quotes{старт/стоп} и \quotes{сброс}.}
\par{Для отображения времени можно воспользоваться семисегментными индикаторами. Значит, для управления каждым из них понадобится семибитная шина, которая будет выходом нашего устройства.}
\par{Для отображения времени выделим 2 индикатора для отображения количества прошедших секунд и 2 индикатора для отображения количества прошедших десятых и сотых долей секунды.}
\par{Значит выходом секундомера будут четыре семибитные шины для управления индикаторами.}
\par{В основе секундомера лежит счётчик. Работая, секундомер отсчитывает время, считая количество пришедших импульсов сигнала синхронизации, частота которого заранее известна.}
\par{Т.е. нам потребуется сигнал синхронизации со стабильной частотой.}
\vspace{4mm}

\par{Больше никаких входов и выходов не требуется.}
\par{Общая схема на данный момент выглядит так:}

\par{---------picture---------}

\par{Начнём описывать модуль на языке \eng{Verilog}:}

\lstinputlisting[caption={Описание входов и выходов модуля на языке \eng{Verilog HDL}}, ]{./code_examples/stopwatch_module.v}

\par{Теперь приступим к описанию \quotes{внутренностей} модуля.}

\par{Чтобы реализовать секундомер, нам необходимо отсчитывать время.}

\par{Для отсчёта времени в цифровых устройствах считают количество прошедших импульсов синхронизации (тактов). Так как тактовые импульсы генерируются кварцевым генератором со стабильной, известной нам, частотой, то мы можем рассчитать количество импульсов, которое соответствует заданному времени.}

\par{Например, если в устройстве установлен кварцевый генератор на 26 МГц, то одной секунде соответствует 26 миллионов тактовых импульсов, а одной сотой секунды соответствует 260 тысяч тактовых импульсов.}

\par{Для того, чтобы отсчитать это количество импульсов подходит единственный из известных нам \quotes{строительных блоков} - счётчик:}

\par{----------picture----------}

\par{Как мы уже говорили, счётчик состоит из регистра и сумматора. Чтобы счётчик циклически отсчитывал одну сотую секунды его необходимо обнулить после того, как он отсчитает 260 тысяч тактовых импульсов. В этот же момент нужно выработать сигнал для остальной схемы, что прошла одна сотая секунды.}

\par{Из всех цифровых блоков, которые мы рассмотрели, для реализации задачи сравнения текущего значения счётчика с константой подходит только компаратор. На один из входов компаратора подадим текущее значение счётчика, а на другой вход - константу 260 000.}

\par{----------picture----------}

\par{Пока значения на входах компаратора будут отличаться, на выходе компаратора будет значение \quotes{0}. Когда значения будут равны, компаратор изменит выход с \quotes{0} на \quotes{1}, это и будет признак того, что прошло 0.01 секунды. Для того, чтобы можно было эффективно использовать сигнал \quotes{прошло 0.01с}, этот сигнал должен иметь длительность равную 1 такту.}

\par{Этот же сигнал мы будет использовать для управления сбросом счётчика.}

\par{Итак, счётчик должен после достижения значения 260 000 принять значение \quotes{0}, но переход должен случиться, как и все остальные переходы, в момент перехода тактового сигнала из \quotes{0} в \quotes{1}.}

\par{Сброс, отвечающий таким условиям, называется \quotes{синхронный сброс}.}

\par{Посмотрите, как будет выглядеть на временной диаграмме как будет работать счётчик если выход компаратора, подключить как сигнал синхронного сброса:}

\par{-----------timing table-----------}

\par{А так выглядит временная диаграмма, если подключить выход компаратора к входу асинхронного сброса триггера:}

\par{-----------timing table-----------}

\par{Выход компаратора, установившись в единицу, моментально сбросит счётчик и, так как значение счётчика изменилось, а значит, изменился и один из входов компаратора, выход компаратора сразу же перейдет в значение \quotes{0}.}

\par{Обратите внимание, что длительность сигнала с выхода компаратора должна быть равна одному такту. Ведь в дальнейшем нам необходимо будет считать события \quotes{прошла одна сотая секунды}, а значит подготовить сигнал единичной длительности, который соответствует этому событию (см. лабораторную работу №3).}

\par{Сигнал с компаратора, в случае, когда он подключен в виде синхронного сброса, полностью удовлетворяет этому условию, а значит нам не придется в дальнейшем вводить новые фрагменты схемы.}

\par{Как реализовать синхронный сброс в цифровом устройстве?}

\par{Для этого можно использовать мультиплексор. Схема будет выглядеть следующим образом:}

\par{----------picture---------}

\par{Если подключить \eng{sync\_reset} к выходу компаратора, то когда счётчик достигнет порогового значения, выход компаратора изменится и переключит мультиплексор. Теперь на выход мультиплексора будет подаваться \quotes{0}. Этот сигнал будет поступать на вход триггера, но запись нового значения произойдет только во время положительного фронта сигнала синхронизации.}

\par{Для общего сброса секундомера при нажатии кнопки \quotes{сброс} как раз можно воспользоваться входом асинхронного сброса регистра. Ведь при нажатии кнопки \quotes{сброс} можно обнулять регистр мгновенно.}

\par{Теперь надо выбрать правильный сигнал управления работой счётчика - сигнал разрешения работы (\eng{Enable}, \eng{EN}). Ведь счётчик должен начинать считать после нажатия кнопки \quotes{старт/стоп}, а после её повторного нажатия должен останавливаться.}

\par{Для управления работой счётчика можно использовать сигнал, который будет единицей, пока счётчик должен работать и нулём, если отсчёт времени остановлен. Как раз такой сигнал можно подать на вход разрешения работы регистра. Назовём этот сигнал \qeng{device\_running}.}

\par{Посмотрите, как выглядит остановка и запуск счётчика в таком случае:}

\par{-----------timing table-----------}

\par{К проектированию и описанию схемы, которая вырабатывала бы сигнал \qeng{device\_running}, мы вернемся позднее.}

\par{Стоит обратить внимание на следующий момент: что будет, если счётчик остановить в тот момент времени, когда его значение стало равно 259999?}

\par{Взгляните на временную диаграмму:}

\par{-----------timing table------------}

\par{Для того чтобы не допустить такого поведения, можно немного изменить условие, запрещающее работу счётчика. Теперь мы будем дополнительно проверять сигнал с компаратора. И если счётчик в данный момент равен 259999, то запретить его работу будет невозможно.}

\par{Для решения этой задачи подойдет вентиль \quotes{или}. Условие будет таким: \quotes{работа разрешена, если сигнал \qeng{device\_running} равен единице \textbf{ИЛИ} когда текущее значение счётчика равно 259999}.}

\par{Теперь схема счётчика выглядит следующим образом:}

\par{------------picture------------}

\par{Когда мы представили схему в виде набора цифровых блоков, мы можем описать её поведение на языке \eng{Verilog}:}

\lstinputlisting[caption={Описание счетчика тактовых импульсов на языке \eng{Verilog HDL}}, ]{./code_examples/pulse_counter.v}

\par{Теперь, когда у нас есть счетчик, отсчитывающий такты и сигнализирующий о том, что прошла сотая доля секунды, мы можем отсчитывать сотые доли секунды.}

\par{Перед нами встаёт выбор.}

\par{Первый вариант – отсчитывать количество прошедших сотых долей секунды единственным счётчиком. Значение этого счётчика мы можем дешифрировать, чтобы выделить из него количество единиц, десятков, сотен и тысяч прошедших долей секунды, чтобы подать эти значения на дешифраторы семисегментных индикаторов:}

\par{------------picture------------}

\par{Второй вариант – использовать отдельные счётчики для сотых долей секунды, десятых долей секунды, целых секунд и десятков секунд.}

\par{Т.е. первый счетчик подсчитывает количество прошедших сотых долей секунды от 0 до 9, и, затем обнуляется, вырабатывая сигнал \quotes{прошла десятая доля секунды}. Следующий счётчик, точно также считает уже десятые доли и вырабатывает сигнал \quotes{прошла одна секунда} и так далее.}

\par{------------picture-------------}

\par{Второй вариант для нас проще в реализации, компактнее, удобнее и понятнее.}

\par{Поэтому выберем именно его.}

\par{В качестве счётчиков подойдет уже описанная нами схема для подсчёта тактов, но с небольшими правками.}

\par{Счетчики подойдут нам потому, что функция их идентична – подсчёт событий с ограничением диапазона. Изменить нужно будет только разрядность счётчика с 16 на 4 и верхнюю границу счёта с 260000 на 9. Тогда счётчик будет выдавать признак переполнения (достижения границы отсчёта, когда его значение будет становиться) девяткой.}

\par{Еще одним моментом, о котором нужно позаботиться – длительность выходного сигнала.}

\par{Пока счётчик считал такты, его значение менялось каждый такт. Компаратор просто не мог принять значение 1 более чем на один такт. Теперь ситуация выглядит следующим образом:}

\par{--------------timing table----------------}

\par{Счетчик будет переключаться каждую 0,01 секунды, 0,1 секунды ,1 секунду или 10 секунд. И выход компаратора будет устанавливаться в 1 на всё время, которое потребуется для переключения счётчика из 9 в ноль. Т.е. в случае счётчика сотых долей секунды потребуется 259999 тактов.}

\par{Как выделить из всего времени, пока счётчик имеет значение \quotes{9} сигнал длительностью в один такт, который возникает в нужный момент времени? На временной диаграмме этот сигнал отмечен как \quotes{прошла 0,1с.}

\par{Сигнал \quotes{прошла 0,1с} можно получить из сигналов, представленных на временной диаграмме следующим образом: \quotes{прошла 0,1с} правда, когда выход компаратора равен единице \textbf{И} \quotes{прошла 0,01с}.}

\par{Схема счётчика практически не изменилась:}

\par{------------------picture------------------}

\par{Скорректируем описание её работы на \eng{Verilog}:}

\lstinputlisting[caption={Описание счетчика сотых долей секунды на языке \eng{Verilog HDL}}, ]{./code_examples/hundredth_counter.v}

\par{Счётчики десятых долей секунды, целых секунд и десятков секунд устроены абсолютно также. В описаниях изменятся только названия сигналов и регистров. Единственное в чем необходимо быть внимательным – это подключение сигналов. Для правильного подключения надо свериться со схемой, которую мы выбрали ранее.}

\par{Теперь вернёмся к вопросам, которые мы отложили ранее.}

\par{В нашем устройстве пока нет описания схемы, которая вырабатывает сигнал \qeng{device\_stopped}. Сигнал должен управляться кнопкой, поэтому как мы уже говорили, в лабораторной работе №3 потребуется схема, синхронизирующая сигнал, поступающий с кнопки с внутренним сигналом \eng{clk} (тактовые импульсы).}

\par{Также сразу выделим из всего нажатия признак того, что кнопка была нажата, так, чтобы по длительности этот признак был равен одному такту.}

\par{Тогда схема будет абсолютно такой же, как и в лабораторной работе №3 и будет выглядеть следующим образом:}

\par{------------------picture------------------}

\par{Поведение такой схемы описывается на языке \eng{Verilog} следующим образом:}

\lstinputlisting[caption={Описание схемы синхранизации на языке \eng{Verilog HDL}}, ]{./code_examples/button_syncroniser.v}

\par{Эта схема и её описание подробно рассмотрены в лабораторной работе №3}

\par{Теперь нам нужно построить схему, которая по нажатию кнопки переключала бы сигнал \quotes{device\_stopped} из \quotes{0} в \quotes{1} и из \quotes{1} в \quotes{0}.}

\par{Что нам понадобится? Триггер, чтобы хранить значение \qeng{device\_stopped}. Чтобы менять значение на противоположное надо знать противоположное значение, значит, нужен инвертор. Событие должно случаться по сигналу \qeng{button\_was\_pressed}, а значит речь, скорее всего, идет о входе разрешения работы триггера.}

\par{Немного подумав над этими вводными, нетрудно составить следующую схему:}

\par{------------------picture------------------}

\par{Временная диаграмма, которая соответствует работе этого устройства:}

\par{------------------timing table------------------}


\par{Описание поведения этой схемы на \eng{Verilog} также не представляет сложности. Выполните его самостоятельно.}

\par{Теперь приведем полное описание секундомера (за исключением схемы, вырабатывающей сигнал \qeng{device\_stopped}), выполненное на языке \eng{Verilog}:}

\lstinputlisting[caption={Описание секундомера на языке \eng{Verilog HDL}}, ]{./code_examples/stopwatch.v}

\section{Задание лабораторной работы:}

\par{Изучить разработку к лабораторной работе.}

\par{Самостоятельно выполнить описание схемы, вырабатывающей сигнал \qeng{device\_stopped}.}

\par{Выполнить синтез и моделирование работы счётчика.}

\par{Продемонстрировать в результатах моделирования фрагменты временных диаграмм, приведенных в заработке.}

\par{Изучить работу устройства, реализованного в ПЛИС учебного стенда.}

\par{Подготовить ответы на вопросы к защите лабораторной работы.}

\section{Вопросы к защите лабораторной работы}

\par{*in progress*}